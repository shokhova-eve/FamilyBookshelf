<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelf - My App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="assets/styles/style.css" rel="stylesheet">
	<link href="assets/styles/epub-books.css" rel="stylesheet">
	<link href="assets/styles/metadata.css" rel="stylesheet">
	<link href="assets/styles/auth.css" rel="stylesheet">
    <script src="assets/js/book-click.js" defer></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">My App</a>
        </div>
    </nav>

    <div class="bookshelf-page">
        <div class="left-section">
            <div class="books-grid">
                <div id="loading" class="loading-indicator">Loading books...</div>
            </div>
        </div>
        <div class="right-section">
            <!-- Right section content -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const booksContainer = document.querySelector('.books-grid');
        const CACHE_KEY = 'books_metadata';
        const CACHE_TIMESTAMP_KEY = 'books_metadata_timestamp';
        const CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days
        
        async function fetchAndCacheBooks() {
            try {
                console.log('Fetching books from server...');
                const response = await fetch('http://localhost:3000/api/books/batch-metadata');
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const booksMetadata = await response.json();
                console.log('Received books metadata:', booksMetadata);
                
                // Store the data and timestamp
                localStorage.setItem(CACHE_KEY, JSON.stringify(booksMetadata));
                localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                
                return booksMetadata;
            } catch (error) {
                console.error('Error in fetchAndCacheBooks:', error);
                throw error; // Re-throw to handle in main try-catch
            }
        }
        
        function getCachedBooks() {
            try {
                console.log('Checking cached data...');
                const cachedData = localStorage.getItem(CACHE_KEY);
                const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                
                if (!cachedData || !timestamp) {
                    console.log('No cached data found');
                    return null;
                }
                
                // Check if cache is expired
                if (Date.now() - parseInt(timestamp) > CACHE_DURATION) {
                    console.log('Cache is expired');
                    localStorage.removeItem(CACHE_KEY);
                    localStorage.removeItem(CACHE_TIMESTAMP_KEY);
                    return null;
                }
                
                const parsedData = JSON.parse(cachedData);
                console.log('Using cached data:', parsedData);
                return parsedData;
            } catch (error) {
                console.error('Error reading cache:', error);
                return null;
            }
        }
        
        async function displayBooks(booksMetadata) {
            try {
                console.log('Displaying books:', booksMetadata);
                booksContainer.innerHTML = ''; // Clear loading indicator
                
                if (!Array.isArray(booksMetadata)) {
                    throw new Error('Books metadata is not an array');
                }
                
                const bookElements = booksMetadata.map(bookData => {
                    const bookElement = document.createElement('div');
                    bookElement.className = 'epub-book';
                    
                    // Parse HTML content if exists in metadata
                    if (bookData.metadata && bookData.metadata.description) {
                        const parser = new DOMParser();
                        const decodedDescription = parser.parseFromString(
                            bookData.metadata.description, 
                            'text/html'
                        ).body.innerHTML;
                        bookData.metadata.description = decodedDescription;
                    }
                    
                    if (bookData.coverUrl) {
                        bookElement.innerHTML = `
                            <img src="${bookData.coverUrl}" 
                                 alt="${bookData.name}" 
                                 loading="lazy"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        `;
                    } else {
                        bookElement.innerHTML = `
                            <div class="no-cover">
                                <p>${bookData.name}</p>
                            </div>
                        `;
                    }
                    
                    bookElement.addEventListener('click', () => {
                        handleBookClick(bookData);
                    });
                    
                    return bookElement;
                });
                
                booksContainer.append(...bookElements);
            } catch (error) {
                console.error('Error in displayBooks:', error);
                throw error;
            }
        }
        
        try {
            // Try to get cached data first
            let booksMetadata = getCachedBooks();
            
            if (booksMetadata) {
                console.log('Using cached book data');
                await displayBooks(booksMetadata);
            } else {
                console.log('Fetching fresh book data');
                booksMetadata = await fetchAndCacheBooks();
                await displayBooks(booksMetadata);
            }
            
        } catch (error) {
            console.error('Main error:', error);
            booksContainer.innerHTML = `
                <div class="error">
                    Error loading books: ${error.message}
                    <br>
                    <button onclick="window.location.reload()">Retry</button>
                </div>`;
        }
    });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="auth-handler.js"></script>
    <script src="book-click.js"></script>
	<script src="main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</body>
</html>
